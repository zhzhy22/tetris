# Feature Specification: Web 俄罗斯方块（Tetris）

**Feature Branch**: `001-web-tetris-10x20`  
**Created**: 2025-10-03  
**Status**: Draft  
**Input**: 为“Web 俄罗斯方块（Tetris）”建立的功能规范需求概述，涵盖目标、范围、用户故事、功能/非功能要求、流程、数据模型及验收要点。

## 概述

### 目标
- 在现代浏览器中提供经典单人俄罗斯方块体验，完整覆盖 10×20 井与标准七种方块。
- 通过明确规范驱动可复用的游戏核心，支撑后续功能扩展与多端体验一致性。

### 成功指标
- 新老玩家可在首次进入后 1 分钟内理解操作并开始游戏。
- 游戏内 HUD 与设置项完整呈现关键信息与可选项，测试覆盖率与性能达到项目宪章基线。

## Clarifications

### Session 2025-10-03
- [x] Q: V1 是否包含 T-Spin、Back-to-Back 或连击计分？ → A: 不包含，后续版本再扩展。
- [x] Q: 预览方块数量是否可配置？ → A: 固定显示 3 个。
- [x] Q: 移动端硬降默认采用哪种手势？ → A: 长下滑触发，手势说明在设置中查看。
- [x] Q: V1 是否需要提供 PWA 安装能力？ → A: 不做安装，仅保证静态资源可离线访问。
- [x] Q: DAS/ARR 与触控阈值是否允许调整？ → A: 默认值遵循宪章（DAS≈170ms、ARR≈40ms、长下滑≥150ms），V1 在设置面板提供有限区间（DAS 150–220ms、ARR 30–60ms、短/长下滑阈值 10–25px/120–200ms）调节，并可一键重置。

## 范围与边界

### 范围内（V1 必须交付）
- 10×20 游戏井、I/O/T/S/Z/J/L 七种方块。
- Super Rotation System（SRS）含墙踢逻辑与锁延迟。
- 7-袋随机生成器，支持注入种子以复现实验和测试。
- 评分与升级体系：单/双/三/四行消除得分分别为 100/300/500/800；软降每格 +1 分、硬降每格 +2 分；行数与等级随进度更新；V1 不实现 T-Spin、Back-to-Back、Combo 额外加成。
- 固定显示 3 个即将出现方块的预览队列与幽灵投影。
- Hold（暂存）功能，每次落子前允许一次暂存交换。
- 键盘操作映射与触控手势（移动、旋转、软/硬降、暂停、暂存）。
- 基础音效及音效开关，高对比模式与幽灵块可开关设置。
- 本地高分与设置持久化，支持响应式布局与离线访问（静态资源形式）。

### 范围外（V1 不交付）
- 联机对战或全球排行榜。
- 皮肤、内购或付费内容。
- 云端存档与跨设备同步。
- 对局回放、录像与分享功能。
- PWA 安装包或原生应用封装（仅保证静态资源可缓存，为后续增强预留）。

## 用户场景与测试

### 主要用户故事
作为单人玩家，我希望在浏览器快速开始俄罗斯方块对局，使用键盘或触控流畅操作，并查看分数与升级，以便持续挑战更高成绩。

### 接受场景
1. **Given** 玩家打开主页，**When** 选择“开始游戏”，**Then** 游戏井初始化、预览与分数面板全部就绪，第一块自动下落。
2. **Given** 玩家处于对局中，**When** 使用键盘或触控执行移动/旋转/软降/硬降/暂存，**Then** 方块按 SRS 与锁延迟规则响应并更新 HUD。
3. **Given** 游戏结束并产生新成绩，**When** 玩家返回主菜单，**Then** 高分榜刷新并持久化，设置保留。

### 边界场景
- 方块堆叠至顶行时立即触发 Game Over 并展示总结面板。
- 离线状态下访问页面，所有核心功能（含本地存储）仍可运作。
- 移动端手势在不同屏幕尺寸下保持可操作区域与反馈一致。

## 需求

### 功能性需求
- **FR-001**：系统必须提供 10×20 网格与七种标准方块，并在游戏开始时填充首个 7-袋序列。
- **FR-002**：系统必须实现 SRS 旋转与墙踢逻辑，确保所有旋转路径与官方标准一致。
- **FR-003**：系统必须对 7-袋随机生成器提供可选种子输入，并在对局数据中记录所用种子以供复现。
- **FR-004**：系统必须实现锁延迟，玩家在方块落地后仍可于设定帧数内调整或旋转。
- **FR-005**：系统必须按规则计算得分（行消/软降/硬降），并在 HUD 实时展示分数、等级、累计行、当前状态；V1 不包含 T-Spin、Back-to-Back 或连击加分。
- **FR-006**：系统必须固定提供 3 个队列预览，与当前活动方块及幽灵预测位置同步更新，并提供自动化测试验证预览长度与同步状态。
- **FR-007**：系统必须提供 Hold 功能，每次落子周期允许一次交换，并在 HUD 显示暂存方块。
- **FR-008**：系统必须支持键盘映射（←/→/↓/↑|X/Z/Space/Shift|C/P|Esc）与等效触控手势（左右滑、轻点/上滑、短/长下滑、屏幕按钮），其中硬降默认由长下滑触发，并在设置面板提供手势说明；同一面板需允许在限定区间内微调 DAS/ARR 与触控短/长下滑阈值，且支持恢复默认。
- **FR-009**：系统必须提供设置面板，可切换音效开关、高对比模式、幽灵显示，并即时应用。
- **FR-010**：系统必须提供音效（消行、硬降、Game Over 等）并遵循设置面板开关。
- **FR-011**：系统必须在本地存储高分记录（至少保存分数、消行数、等级、日期）与设置偏好，页面重载仍保留。
- **FR-012**：系统必须支持离线访问，静态资源缓存使用户在无网络时可启动游戏。
- **FR-013**：系统必须提供暂停/恢复流程，并在暂停期间冻结计时、输入与渲染。

### 非功能性需求
- **NFR-001**：渲染目标为 60 FPS，常规游玩中不得出现可感知掉帧；性能测试需覆盖连续 20 分钟游玩。
- **NFR-002**：首屏包体（不含音频）MUST ≤150 KB gzip，并通过脚本与 CI 审计记录基线与防回归阈值。
- **NFR-003**：兼容主流现代浏览器（Chromium、Firefox、Safari）及常见移动设备视口。
- **NFR-004**：满足 WCAG 2.1 AA 对比度要求，键盘可完全操作，aria-live 播报关键状态，提供高对比主题与音量调节/静音。
- **NFR-005**：离线模式、设置切换与高分存储需在 7-袋种子复现实验流程中验证可靠性。

## 用户流程
1. 玩家访问入口页面，加载主菜单。
2. 玩家选择“开始游戏”，显示游戏井、HUD、预览、Hold、设置入口。
3. 对局进行中，玩家可随时：
   - 使用键盘或触控输入操作方块。
   - 打开设置调整音效、高对比、幽灵显示。
   - 暂停或恢复游戏。
4. 方块触顶触发 Game Over，展示结算界面并更新本地高分。
5. 玩家可选择重新开始或返回主菜单。

## 数据模型

### Key Entities
- **Settings**：存储 soundEnabled、highContrast、showGhost 等布尔设置，支持即时生效与持久化。
- **HighScoreEntry**：包含 score、lines、level、date，用于本地高分榜，保存至少若干条记录并按分数排序。
- **GameSessionState**：描述当前对局，包括 Board（二维数组）、ActivePiece、HoldPiece、NextQueue（固定 3 个）、Score、Level、Lines、Seed、LockDelayState、GameState（playing/paused/gameOver）。

## 验收清单
- [ ] SRS 旋转、墙踢、锁延迟行为均通过单元与端到端测试验证。
- [ ] 7-袋算法支持种子复现，测试覆盖典型种子与回放案例。
- [ ] 键盘操作与触控手势在桌面与移动端均可达到等效控制。
- [ ] 预览、幽灵、Hold、HUD 数据在游戏过程中持续正确更新。
- [ ] 连续 20 分钟游玩性能与内存表现满足 60 FPS 目标，无明显泄漏。
- [ ] 可访问性（对比度、aria-live、键盘操作、音量控制、高对比模式）通过审核。
- [ ] 本地设置与高分在刷新或离线条件下仍可读取与更新。
- [ ] README 覆盖玩法、操作、构建、部署说明，测试覆盖率达到项目宪章门槛。
